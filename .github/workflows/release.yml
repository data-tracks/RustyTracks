name: Build and Release

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'The Git tag for the release (e.g., v1.0.0, v1.2.3-beta)'
        required: true
        type: string
      release_name:
        description: 'The name of the release (defaults to tag_name)'
        required: false
        type: string
        default: '' # Will be handled in the step if not provided
      release_body:
        description: 'Custom release notes content'
        required: false
        type: string
        default: |
          ## Release Notes

          This release was manually triggered.
          Please provide detailed notes for future releases!

      draft:
        description: 'Create a draft release (true/false)'
        required: false
        type: boolean
        default: false
      prerelease:
        description: 'Mark as a pre-release (true/false)'
        required: false
        type: boolean
        default: false

jobs:
  build:
    runs-on: ${{ matrix.os }} # Define the operating system on which the job runs
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest] # Define the operating system matrix
        arch: [x86_64, aarch64] # Define the architecture matrix

    steps:
      - name: Checkout code
        uses: actions/checkout@v4 # Check out the repository code

      - name: Set up Rust
        uses: actions-rs/toolchain@v1 # Set up the Rust toolchain
        with:
          toolchain: stable # Use the stable Rust toolchain
          profile: minimal # Use the minimal configuration file
          override: true # Override any existing Rust toolchain settings

      - name: Build project
        run: cargo build --release # Build the release version of the project

      # Upload build artifacts for Linux x86_64 platform
      - name: Upload artifact (Linux)
        if: matrix.os == 'ubuntu-latest' && matrix.arch == 'x86_64'
        uses: actions/upload-artifact@v2
        with:
          name: ubuntu-latest-heaven
          path: target/release/heaven

      # Upload build artifacts for Linux aarch64 platform
      - name: Upload artifact (Linux aarch64)
        if: matrix.os == 'ubuntu-latest' && matrix.arch == 'aarch64'
        uses: actions/upload-artifact@v2
        with:
          name: ubuntu-latest-heaven-aarch64
          path: target/release/heaven

      # Upload build artifacts for macOS x86_64 platform
      - name: Upload artifact (macOS)
        if: matrix.os == 'macos-latest' && matrix.arch == 'x86_64'
        uses: actions/upload-artifact@v2
        with:
          name: macos-latest-heaven
          path: target/release/heaven

      # Upload build artifacts for macOS aarch64 platform
      - name: Upload artifact (macOS aarch64)
        if: matrix.os == 'macos-latest' && matrix.arch == 'aarch64'
        uses: actions/upload-artifact@v2
        with:
          name: macos-latest-heaven-aarch64
          path: target/release/heaven

      # Upload build artifacts for Windows x86_64 platform
      - name: Upload artifact (Windows)
        if: matrix.os == 'windows-latest' && matrix.arch == 'x86_64'
        uses: actions/upload-artifact@v2
        with:
          name: windows-latest-heaven
          path: target/release/heaven.exe

      # Upload build artifacts for Windows aarch64 platform
      - name: Upload artifact (Windows aarch64)
        if: matrix.os == 'windows-latest' && matrix.arch == 'aarch64'
        uses: actions/upload-artifact@v2
        with:
          name: windows-latest-heaven-aarch64
          path: target/release/heaven.exe

  release:
    runs-on: ubuntu-latest # Define the job to run on Ubuntu
    needs: build # Depends on the build job

    steps:
      - name: Checkout code
        uses: actions/checkout@v2 # Check out the repository code

      # Download build artifacts for Linux x86_64 platform
      - name: Download artifact (Linux-x86_64)
        uses: actions/download-artifact@v2
        with:
          name: ubuntu-latest-heaven
          path: artifacts/ubuntu

      # Download build artifacts for macOS x86_64 platform
      - name: Download artifact (macOS-x86_64)
        uses: actions/download-artifact@v2
        with:
          name: macos-latest-heaven
          path: artifacts/macos

      # Download build artifacts for Windows x86_64 platform
      - name: Download artifact (Windows-x86_64)
        uses: actions/download-artifact@v2
        with:
          name: windows-latest-heaven
          path: artifacts/windows

      # Download build artifacts for Linux aarch64 platform
      - name: Download artifact (Linux-aarch64)
        uses: actions/download-artifact@v2
        with:
          name: ubuntu-latest-heaven-aarch64
          path: artifacts/ubuntu

      # Download build artifacts for macOS aarch64 platform
      - name: Download artifact (macOS-aarch64)
        uses: actions/download-artifact@v2
        with:
          name: macos-latest-heaven-aarch64
          path: artifacts/macos

      # Download build artifacts for Windows aarch64 platform
      - name: Download artifact (Windows-aarch64)
        uses: actions/download-artifact@v2
        with:
          name: windows-latest-heaven-aarch64
          path: artifacts/windows

      - name: Create release
        id: create_release
        uses: actions/create-release@v1 # Create a GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }} # Authenticate using GitHub token
        with:
          tag_name: ${{ github.event.inputs.tag_name }} # Use the pushed tag name
          release_name: ${{ github.event.inputs.release_name || format('Release {0}', github.event.inputs.tag_name) }} # Use the pushed tag name as the release name
          body: ${{ github.event.inputs.release_body }}
          draft: ${{ github.event.inputs.draft }} # Whether it's a draft
          prerelease: ${{ github.event.inputs.prerelease }} # Whether it's a prerelease

      # Upload Linux x86_64 build artifact to the release page
      - name: Upload Linux x86_64 artifact
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }} # Authenticate using GitHub token
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }} # Use the upload URL generated by the create release step
          asset_path: artifacts/ubuntu/heaven # Path of the file to upload
          asset_name: heaven-linux-x86_64 # Name of the file to upload
          asset_content_type: application/octet-stream # File content type

      # Upload macOS x86_64 build artifact to the release page
      - name: Upload macOS x86_64 artifact
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }} # Authenticate using GitHub token
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }} # Use the upload URL generated by the create release step
          asset_path: artifacts/macos/heaven # Path of the file to upload
          asset_name: heaven-macos-x86_64 # Name of the file to upload
          asset_content_type: application/octet-stream # File content type

      # Upload Windows x86_64 build artifact to the release page
      - name: Upload Windows x86_64 artifact
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }} # Authenticate using GitHub token
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }} # Use the upload URL generated by the create release step
          asset_path: artifacts/windows/heaven.exe # Path of the file to upload
          asset_name: heaven-windows-x86_64.exe # Name of the file to upload
          asset_content_type: application/octet-stream # File content type

      # Upload Linux aarch64 build artifact to the release page
      - name: Upload Linux aarch64 artifact
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }} # Authenticate using GitHub token
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }} # Use the upload URL generated by the create release step
          asset_path: artifacts/ubuntu/heaven # Path of the file to upload
          asset_name: heaven-linux-aarch64 # Name of the file to upload
          asset_content_type: application/octet-stream # File content type

      # Upload macOS aarch64 build artifact to the release page
      - name: Upload macOS aarch64 artifact
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }} # Authenticate using GitHub token
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }} # Use the upload URL generated by the create release step
          asset_path: artifacts/macos/heaven # Path of the file to upload
          asset_name: heaven-macos-aarch64 # Name of the file to upload
          asset_content_type: application/octet-stream # File content type

      # Upload Windows aarch64 build artifact to the release page
      - name: Upload Windows aarch64 artifact
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }} # Authenticate using GitHub token
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }} # Use the upload URL generated by the create release step
          asset_path: artifacts/windows/heaven.exe # Path of the file to upload
          asset_name: heaven-windows-aarch64.exe # Name of the file to upload
          asset_content_type: application/octet-stream # File content type


